#!/usr/bin/env bash
set -euo pipefail
IFS=$'\n\t'

SCRIPTVERSION="0.9"
LASTUPDATED="2024-08-27"
AUTHOR="Dustin Hoffmann"

### the Splunk server needs a connection to https://endoflife.date in order to work

# this script checks for new a new version of the kernel end of life JSON 
init()
{
	appPath="${SPLUNK_HOME}/etc/apps/app_eavc"
	dataPath="${appPath}/data"
	tmpDir="${appPath}/tmp"
	rawJsonLocation="https://endoflife.date/api/linux.json"

	kernelVersions="linux.json"

	getMD5_current="$(md5sum $dataPath/$kernelVersions | awk '{ print $1 }')"

}


### function calls
main()
{
	createTempDir
	pullKernelVersions
	compareKernelVersions
	deleteTempDir
}

compareKernelVersions()
{
	getMD5_downloaded="$(md5sum $tmpDir/$kernelVersions | awk '{ print $1 }')"
	if [ "$getMD5_current" == "$getMD5_downloaded" ]
		then
			#printf "MD5 sums are matching. No replacement. \n"
			return 0
		else
			#printf "DEBUG: replacing due to md5 mismatch - $lookupPath/$svdTable by $tmpDir/$svdTable \n"
			eval cp ${tmpDir}/${kernelVersions} ${dataPath}/${kernelVersions}
			#printf "\n md5sum getMD5_current: $getMD5_current \n"
			#printf "md5sum getMD5_downloaded: $getMD5_downloaded \n"
	fi


}

createTempDir()
{
	#printf "DEBUG: Creating $tmpDir \n"
	mktemp -d $tmpDir 2>/dev/null
}

deleteTempDir()
{
	#printf "DEBUG: deleting $tmpDir \n"
	rm -r $tmpDir
}

pullKernelVersions()
{
	eval wget ${rawJsonLocation} -O $tmpDir/$kernelVersions 2> /dev/null
	#printf "DEBUG: Downloaded $kernelVersions \n"
}



init $@
main $?


